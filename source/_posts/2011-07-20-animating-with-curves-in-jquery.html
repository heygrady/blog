---
layout: post
title: "Animating With Curves in jQuery"
date: 2011-07-20 11:48
comments: true
categories: 
---
<p>jQuery has a really strong animation library built in that makes it very easy to animate a CSS property with very little JavaScript. However, it's not well suited to animating complex things that are not directly related to CSS. In particular, tweening an element along a curve or animating a <code>canvas</code> &mdash; which doesn't use CSS at all &mdash; is more difficult.</p>
<p>To solve these issues I've created two new jQuery plug-ins: <a href="https://github.com/heygrady/curve">jQuery Tween and jQuery Curve</a>.</p>
<!--more-->
<h2>Tweening an object.</h2>
<p>Tween simply uses the existing jQuery animation functions to manage the animation frames but leaves the application of the animation to the user. This essentially means that instead of animating a specific CSS property, tween simply fires a callback function. This is very similar to using the step callback option for jQuery animate but it removes some of the calculation overhead. Tween makes it easy to animate something like a <code>canvas</code> element which jQuery animate doesn't handle by default.</p>
<p><iframe width="100%" height="300" frameborder="0" src="http://jsfiddle.net/heygrady/Rx5Wv/embedded/result%2Cjs/"></iframe></p>
<p>In the example above, a sine wave is drawn on a <code>canvas</code> over 3 seconds. The first argument in the tween plug in is a step function while all other arguments match the default jQuery animation function. The step function receives 2 arguments, the current value and the <code>fx</code> object. When using the tween function, the current value passed is always equal to the current animation time. When using jQuery animate the current value is the value of the CSS property being animated. As the example above shows, the tween plug-in makes it much easier to animate something besides a standard CSS property.</p>
<p>Conceptually, the tween plug-in is similar to animating a custom property with jQuery's built-in animate function. The example below shows the exact same behavior as the example above using the native jQuery animate with a custom property instead of using the tween function.</p>
<p><iframe width="100%" height="300" frameborder="0" src="http://jsfiddle.net/heygrady/jMe5K/embedded/result%2Cjs/"></iframe></p>
<p>While using animate directly is similar to tween, animate causes jQuery to perform a series of property lookups and calculations on initialization that are skipped with tween. Additionally, tween adds a special step function to the <code>fx</code> object that overrides jQuery's default behavior to avoid any additional calculations on each step of the animation.</p>
<p>It's also worth noting that the normal jQuery animate calls the step function once for each property being animated. So if you're animating five properties (height, width, etc.) with the native jQuery animate function, a step function is called five times for each step of the animation. The tween plug-in avoids these extra function calls.</p>
<h2>Using Curves</h2>
<p>The curve plug-in contains a handful of useful functions for plotting curves as a function of time and works well with the tween plug-in. The curves supported natively are circle, ellipse, sine, and bezier curves. It would be possible to define additional curves quite easily by extending the curve object. Each function takes a similar set of options and returns x and y coordinates.</p>
<p><iframe width="100%" height="300" frameborder="0" src="http://jsfiddle.net/heygrady/eFDe5/embedded/result%2Cjs/"></iframe></p>
<p>The example above uses a curve function to draw a sine wave. The curve function actually returns 3 values in the array: x, y and the angle of the tangent line. The tangent angle can be used to rotate an object to follow the curve. As you can see, the curve function makes it easier to calculate a sine wave as a function of time.</p>
<h3>A curve as a function of time</h3>
<p>jQuery animate is using a simple concept of percentage of completion to perform animations. In a simple 1 second animation &mdash; let's animate the height property &mdash; jQuery will look at the current height value and the final height and calculate the difference. Next jQuery will calculate the current time and the duration &mdash; again, 1 second in this example &mdash; and start an interval timer. At each interval the percentage of the duration is calculated. That percentage is essentially the current time divided by the final time. The percentage is then altered by the easing function to speed up or slow down time before it is applied to the value in question.</p>
<p>Consider animating the height from 0px to 10px over 1 second. At 500ms the animation is 50% completed. In a step function the <code>fx</code> object reflects this as an <code>fx.state</code> of 0.5. The <code>fx.pos</code> will be slightly different based on the easing function; but with the default easing it is 0.4999. The current height is the start value plus the difference multiplied by the current position. This means 0px + 10px * 0.4999 which is 4.999px. Of course the differences between <code>fx.state</code> and <code>fx.pos</code> can be more dramatic depending on the <code>fx.state</code>. For instance, an <code>fx.state</code> of 0.25 corresponds to an <code>fx.pos</code> of 0.1464 using the default easing.</p>
<p>The value of <code>fx.pos</code> is essentially a percentage of completion and is important for plotting curves. Any curve, like a circle, has a start and an end point. Simple trigonometry can be used to calculate any point on a circle at a certain time. This makes it trivial to use such a function for drawing a curves as the example below shows.</p>
<p><iframe width="100%" height="300" frameborder="0" src="http://jsfiddle.net/heygrady/X5fw4/embedded/result%2Cjs/"></iframe></p>
<p>The example above isn't animating the circle, it's drawing it as a series of line segments using a loop. The current position on the circle is calculated for each iteration of the loop. Even though it isn't animated, the circle is still drawn as a function of time. <strong>NOTE:</strong> if all you want to do is <a href="https://developer.mozilla.org/en/Canvas_tutorial/Drawing_shapes">draw a circle on a <code>canvas</code></a> there's easier ways.</p>
<h3>Using the tangent angle</h3>
<p>In addition to the x and y coordinates, the curve functions can also return a tangent angle which can be used to rotate the element in order for it to follow the curve. The tangent is returned in radians. In the example below, the angle of the rocket ship angle is set to the tangent angle so it will appear to follow the sine wave as it moves.</p>
<p><iframe width="100%" height="300" frameborder="0" src="http://jsfiddle.net/heygrady/BLMLu/embedded/result%2Cjs/"></iframe></p>
<h2>Putting it all together</h2>
<p>The example below shows each of the supported curves in action. The tween plug-in is used to animate and rotate a rocket ship along a curve while simultaneously drawing the exact same curve on a <code>canvas</code>. This demonstrates the utility of separating the jQuery animate functionality from straight CSS operations &mdash; animating a <code>div</code> and drawing on a <code>canvas</code> at the same time.</p>
<p><iframe width="100%" height="310" frameborder="0" src="http://jsfiddle.net/heygrady/j5tHC/embedded/result%2Cjs/"></iframe></p>